name: Build Linux ARM64 (GoReleaser)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: üì¢ Notify Start
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ARM64 Started üöÄ" \
            -H "Tags: rocket,construction_worker" \
            -H "Priority: default" \
            -d "Branch: ${{ github.ref_name }} | Commit: ${{ github.sha }}" \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        id: setup-go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Determine Fork Version
        id: version
        run: |
          # Dapatkan tag terbaru dari history (mungkin sudah ada akhiran -fork)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # Hilangkan akhiran -fork-* agar kita mendapatkan base version aslinya (misal: v0.1.2)
          BASE_TAG=$(echo "$LATEST_TAG" | sed -E 's/-fork-[0-9]+//g')
          
          # Format increment number menggunakan run number (misal: 01, 02)
          RUN_NUM=$(printf "%02d" ${{ github.run_number }})
          
          # Gabungkan menjadi versi custom untuk fork
          FORK_VERSION="${BASE_TAG}-fork-${RUN_NUM}"
          
          echo "Ditemukan tag asli: $BASE_TAG"
          echo "Versi fork yang digunakan: $FORK_VERSION"
          echo "FORK_VERSION=$FORK_VERSION" >> $GITHUB_ENV

      - name: Restrict GoReleaser to linux/arm64
        run: |
          yq -i '.project_name = "picoclaw"' .goreleaser.yaml
          yq -i '.builds[0].goos = ["linux"]' .goreleaser.yaml
          yq -i '.builds[0].goarch = ["arm64"]' .goreleaser.yaml
          yq -i 'del(.builds[0].ignore)' .goreleaser.yaml
          yq -i 'del(.dockers_v2)' .goreleaser.yaml

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ~> v2
          args: release --clean --snapshot
        env:
          GOVERSION: ${{ steps.setup-go.outputs.go-version }}
          # Override GORELEASER_CURRENT_TAG agar binary terkompilasi dengan versi yang benar
          GORELEASER_CURRENT_TAG: ${{ env.FORK_VERSION }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: picoclaw-linux-arm64-${{ env.FORK_VERSION }}
          path: dist/*.tar.gz
          if-no-files-found: warn

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.FORK_VERSION }}" dist/*.tar.gz \
            --title "Fork Build ${{ env.FORK_VERSION }}" \
            --notes "Automated release from branch ${{ github.ref_name }}."

      - name: üì¢ Notify Success
        if: success()
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ARM64 Success ‚úÖ" \
            -H "Tags: white_check_mark,partying_face" \
            -H "Priority: high" \
            -d "Build artifact picoclaw-linux-arm64-${{ env.FORK_VERSION }} has been successfully uploaded." \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib

      - name: üì¢ Notify Failure
        if: failure()
        run: |
          curl \
            -H "Title: Deploy picoclaw Linux ARM64 Failed ‚ùå" \
            -H "Tags: x,skull" \
            -H "Priority: urgent" \
            -d "Build failed on branch ${{ github.ref_name }}. Please check the GitHub Actions logs." \
            https://ntfy.sh/deploy-on-github-xasr6KBz47PjswPf53A78Fib
